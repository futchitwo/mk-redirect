<!DOCTYPE html>
<html>
  <head>
    <title>連合に照会</title>
    <style>
      *{
        background:#ccc;
      }
    </style>
  </head>
  <body>
    <p id="progresstext">連合に照会します。</p>
    <a id="statuslink"></a>
    <div id="register-token" style="display: none;">
      <p>転送先インスタンス(<var id="register-dist"></var>)のノート検索用アクセストークンが登録されていません。<br/>以下のリンクより連携をお願いします。</p>
      <a id="registerlink-mi12">Misskey v12系</a> 
      <a id="registerlink-mi10">Misskey v10系</a> 
    </div>
    <div id="delete-token" style="display: none;">
      <button id="delete-token-button"></button>
    </div>
    <hr />
    <p>
      Plugin source: 
      <a href="https://misskey.io/@hakohako_f2/pages/open-in-other-instance">misskey.io/@hakohako_f2/pages/open-in-other-instance</a>
    </p>
    <p>
      Redirect page source: 
      <a href="https://github.com/futchitwo/mk-redirect">github.com/futchitwo/mk-redirect</a>
    </p>
    <script>
      const progressText = document.querySelector("#progresstext");
      const linkHtml = document.querySelector("#statuslink");
      //const showRegisterTokenDiv = () => document.querySelector("#register-token").setAttribute("style", "display:unset");
      //const showDeleteTokenDiv = (dest) => document.querySelector("#")
      async function main(){
        try{
          const params = new URL(document.location).searchParams;
          if(params === {}) throw "パラメーターが指定されていません。";
          
          const dest = params.get('dest');
          const uri = decodeURI(params.get('uri'));
          let i = params.get('i') || localStorage.getItem(dest);
          console.log("dest: "+dest+" uri: "+uri);
          if(!dest || !uri) throw "適切なパラメーターが指定されていません。";
          
          progressText.innerText = "連合に照会中......";
          const res = await fetch(`https://${dest}/api/ap/show`, {
            method: "POST",
            body: JSON.stringify({ uri: uri, i: i })
          });
          const resjson = await res.json();
          
          const redirectUrl = "https://" + dest + "/notes/" + resjson.object.id;
          progressText.innerText = "照会が完了しました。自動的にリダイレクトします。";
          linkHtml.innerText = redirectUrl;
          linkHtml.setAttribute("href", redirectUrl);
          location.replace(redirectUrl);
        }catch(err){
          progressText.innerText = "照会に失敗しました：" + err;
        }
      }
      main();
    </script>
  </body>
</html>
